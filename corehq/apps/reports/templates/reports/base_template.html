{% extends "hqwebapp/two_column.html" %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
    {% include "imports/datatables.html" %}
    <script src="{% static 'reports/javascripts/config.dataTables.bootstrap.js' %}"></script>
    {% include "imports/flot.html" %}
    <script src="{% static 'hqwebapp/javascripts/jquery-ui-datepicker/jquery-ui-1.8.17.custom.datepicker.min.js' %}"></script>
    <script src="{% static 'hqwebapp/js-custom/hq.legacy.js' %}"></script>
    <script src="{% static 'hqwebapp/javascripts/jquery.history.js' %}"></script>
    <script src="{% static 'hqwebapp/javascripts/knockout.mapping.js' %}"></script>
    <script src="{% static 'hqwebapp/js/knockout-bindings.js' %}"></script>
    <script src="{% static 'reports/javascripts/datepicker.js' %}"></script>
    <script src="{% static 'reports/javascripts/reports.config.js' %}"></script>
    <script src="{% static 'reports/javascripts/reports.async.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
var standardHQReport = new HQReport({
    domain: '{{ domain }}',
    urlRoot: '{{ report.url_root }}',
    slug: {{ report.slug|JSON }},
    subReportSlug: {{ report.sub_slug|JSON }},
    type: {{ report.type|JSON }},
    filterSet: {{ report.filter_set|JSON }},
    needsFilters: {{ report.needs_filters|JSON }},

    {% if request.datespan %}
    datespan: {
        startdate: '{{ datespan.startdate|date:"Y-m-d" }}',
        enddate: '{{ datespan.enddate|date:"Y-m-d" }}'
    },
    {% endif %}
});
standardHQReport.init();

{% if report.slug and report.is_async %}
    var asyncHQReport = new HQAsyncReport({
        standardReport: standardHQReport
    });
    asyncHQReport.init();
{% endif %}

$(function() {
    $("#reportFavorites").reportConfigEditor({
        items: {{ report_configs|JSON }},
        initialItemID: '{{ current_config_id }}',
        defaultItem: {{ default_config|JSON }},
        saveUrl: '{% url add_report_config domain %}',
    });
    
    if ($("#reportFilters").hasClass('in')) {
        $("#reportFilters").css('overflow', 'visible');
    }

    $("#reportFilters").on('shown', function() {
        $(this).css('overflow', 'visible'); 
    });

    $("#reportFilters").on('hide', function() {
        $(this).css('overflow', 'hidden');
    });

});
</script>
{% endblock %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'hqwebapp/javascripts/jquery-ui-datepicker/datepicker-theme/jquery-ui-1.8.17.custom.css' %}" />
{% endblock %}

{% block title %} - Report: {{ report.title|default:"Project Reports"|safe }}{% endblock %}

{% block header-section %} {{ block.super }}
{% if report.show_subsection_navigation %}
    {% block subsection-navigation %}
    <nav class="hq-subsection-navbar">
        <ul class="nav">
            <li {% ifequal report.section_name 'Project Reports' %}class="active"{% endifequal %}><a href="{% url default_report domain %}">Project Reports</a> <div class="arrow"></div></li>
            <li {% ifequal report.section_name 'Active Data Management' %}class="active"{% endifequal %}><a href="{% url default_adm_report domain %}">Active Data Management</a> <div class="arrow"></div></li>
        </ul>
    </nav>
    {% endblock %}
{% endif %}
{% endblock %}

{% block page-title %}

    <ul class="breadcrumb">
        <li>
            <a href="{{ report.default_url }}"><strong>{{ report.section_name|default:"Reports" }}</strong></a> <span class="divider">&gt;</span>
        </li>
    {% if report.breadcrumbs %}
        {% for crumb in report.breadcrumbs %}
        <li>
            <a href="{{ crumb.link }}">{{ crumb.title }}</a> <span class="divider">&gt;</span>
        </li>
        {% endfor %}
    {% endif %}
        <li class="active">
            <div id="report-title"><a href="{{ report.url }}">{{ report.title|default:"Untitled Report"|safe }}</a></div>
        </li>
    </ul>
{% endblock %}

{% block sidebar %}{% include "reports/partials/report_list.html" %}{% endblock %}
{% block main_column %}
    <div class="hq-accordion-control{% if report.is_async%} hide{% endif %}" id="reportFiltersAccordion">
        <div class="accordion-heading">
            <div class="accordion-actions">
                {% if report.show_filters %}
                <a href="#reportFilters" class="btn" id="toggle-report-filters"
                   data-toggle="collapse" data-show-text="Show Filter Options"
                   data-hide-text="Hide Filter Options">
                    Filter Options
                </a>
                {% endif %}

                {% if report.is_exportable %}
                <a href="#" class="btn" id="export-report-excel">
                    <i class="icon icon-share"></i> Export to Excel
                </a>
                {% endif %}
            </div>
            <div id="extra-filter-info" class="accordion-extra"></div>
        </div>
        
        {% if report.show_filters %}
            <div id="reportFilters" class="accordion-body collapse">
                <div class="accordion-inner">
                    <form method="get" id="paramSelectorForm" class="form-horizontal">
                        <div id="hq-report-filters">
                            {% if not report.is_async %}
                                {% include "reports/async/filters.html" %}
                            {% endif %}
                        </div>
                        <div id="reportFavorites" class="form-actions">
                            <div class="btn-toolbar">
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-large disabled"
                                        data-loading-text="Generating Report..."
                                        data-standard-text="Apply">
                                        Apply
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <a class="btn btn-large dropdown-toggle" data-toggle="dropdown">
                                        Favorites<span class="caret"></span>
                                    </a>

                                    <ul class="dropdown-menu">
                                        <li data-bind="ifnot: reportConfigs().length">
                                            <a href="#">You don't have any favorites</a>
                                        </li>
                                        <!-- ko foreach: reportConfigs -->
                                        <li>
                                            <a href="#" tabindex="-1"
                                                data-bind="text: name, attr: { title: description }, click: $root.setConfigBeingViewed">
                                            </a>
                                        </li>
                                        <!-- /ko -->
                                    </ul>
                                </div>

                                <button class="btn btn-large"
                                    data-bind="click: setConfigBeingEdited">
                                    Save...
                                </button>
                            </div>
                            <div id="report-config-modal" data-bind="modal: configBeingEdited">
                                <div data-bind="with: configBeingEdited">
                                    <div class="modal-header">
                                        <a class="close" data-bind="click: $root.unsetConfigBeingEdited">Ã—</a>
                                        <h3 data-bind="text: modalTitle"></h3>
                                    </div>
                                    <form class="form-horizontal">
                                        <div class="modal-body">
                                            <div class="control-group">
                                                <label class="control-label" for="name">Name</label>
                                                <div class="controls">
                                                    <input type="text" id="name" data-bind="value: name" placeholder="Name"/>
                                                </div>
                                            </div>
                                            <div class="control-group">
                                                <label class="control-label" for="description">Description</label>
                                                <div class="controls">
                                                    <textarea rows="3" name="description" data-bind="value: description" placeholder="Description"></textarea>
                                                </div>
                                            </div>

                                            <div class="control-group">
                                                <label class="control-label" for="date_range">Default Date Range</label>
                                                <div class="controls">
                                                    <select name="date_range" data-bind="value: date_range">
                                                        <option value="last7">Last 7 days</option>
                                                        <option value="last30">Last 30 days</option>
                                                        <option value="lastn">Days ago</option>
                                                        <option value="since">Since a date</option>
                                                        <option value="range">From a date to a date</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="control-group" data-bind="visible: date_range() == 'lastn'">
                                                <label class="control-label" for="days">Number of Days</label>
                                                <div class="controls">
                                                    <input type="number" name="days" min="1" step="1" data-bind="value: days"/>
                                                </div>
                                            </div>
                                            <div class="control-group" data-bind="visible: date_range() == 'since' || date_range() == 'range'">
                                                <label class="control-label" for="start_date">Begin Date</label>
                                                <div class="controls">
                                                    <input type="text" class="date-picker" name="start_date" placeholder="YYYY-MM-DD" data-bind="value: start_date"/>
                                                </div>
                                            </div>
                                            <div class="control-group" data-bind="visible: date_range() == 'range'">
                                                <label class="control-label" for="end_date">End Date</label>
                                                <div class="controls">
                                                    <input type="text" class="date-picker" name="end_date" placeholder="YYYY-MM-DD" data-bind="value: end_date"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <div class="btn-toolbar">
                                                <div class="btn-group">
                                                    <a href="#" class="btn" data-bind="click: $root.unsetConfigBeingEdited">Cancel</a>
                                                </div>
                                                <div class="btn-group">
                                                    <span data-bind="saveButton2: $root.modalSaveButton.state, saveOptions: $root.modalSaveButton.saveOptions"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>
    <div id="report-content">
        {% if not report.is_async and report.slug %}
            {% block reportcontent %}
            {% endblock %}
        {% else %}
            {% include "reports/async/default.html" %}
        {% endif %}
    </div>
{% endblock %}

