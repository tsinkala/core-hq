{% extends "reports/base_template.html" %}
{% load hq_shared_tags %}
{% load i18n %}

{% block js %}
    {{ block.super }}
    <script src="{% static 'hqwebapp/js/lib/jquery-ui/jquery-ui-1.8.16.min.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
    <script>
        var CustomExportView = {
            wrap: function (o) {
                var self = ko.mapping.fromJS(o);

                self.utils = {
                    stripIndex: function (index) {
                        var stripped;
                        if (self.custom_export.type() === 'form') {
                            index = ko.utils.unwrapObservable(index);
                            stripped = index.replace(/^#.form.(.*).#$/, '$1');
                            if (index !== stripped) {
                                return stripped;
                            }
                            stripped = index.replace(/^#.(.*).#$/, '$1 (meta)');
                        } else {
                            stripped = index.replace(/^#.(.*).#$/, '$1');
                        }
                        stripped = stripped.replace(/.#./g, ' > ');
                        return stripped;
                    },
                    parseField: function (field, index) {
                        var stripped;
                        field = ko.utils.unwrapObservable(field);
                        index = ko.utils.unwrapObservable(index);
                        if (field in {id:0, _id:0, _rev:0, doc_type:0}) {
                            return {tag: 'server', field: field};
                        }
                        if (self.custom_export.type() === 'form' && index === '#') {
                            stripped = field.replace(/^form.meta.(.*)$/, '$1');
                            if (field !== stripped) {
                                return {tag: 'meta', field: stripped};
                            }
                            stripped = field.replace(/^form.(.*)$/, '$1');
                            if (field !== stripped) {
                                return {tag: '', field: stripped};
                            }
                            return {tag: 'server', field: stripped};
                        } else {
                            return {tag: '', field: field};
                        }
                    }
                };

                self.showDeidColumn = ko.observable(function () {
                    return _(self.table_configuration()).some(function (table) {
                        return table.selected() && _(table.column_configuration()).some(function (column) {
                            return column.selected() && column.transform();
                        });
                    });
                }());

                self.animateShowDeidColumn = function () {
                    $('html, body').animate({
                        scrollTop: $('#field-select').offset().top + 'px'
                    }, 'slow', undefined, function () {
                        self.showDeidColumn(true);
                    });

                };

                self.setAllSelected = function (table, selected) {
                    _(table.column_configuration()).each(function (column) {
                        column.selected(selected);
                    });
                };
                self.selectAll = function (table) {
                    self.setAllSelected(table, true);
                };
                self.selectNone = function (table) {
                    self.setAllSelected(table, false);
                };

                self.make_tables = function () {
                    return ko.mapping.toJS(
                        _(self.table_configuration()).filter(function (table) {
                            return table.selected();
                        }).map(function (table) {
                            return {
                                display: table.display,
                                index: table.index,
                                columns: _(table.column_configuration()).filter(function (column) {
                                        return column.selected();
                                    }).map(function (column) {
                                        return {
                                            index: column.index,
                                            display: column.display,
                                            transform: column.transform() || null // it doesn't save '' well
                                        };
                                    })
                            }
                        })
                    );
                };

                self.output = ko.computed(function () {
                    var output = ko.mapping.toJS({
                        custom_export: self.custom_export,
                        presave: self.presave
                    });
                    output.custom_export.tables = self.make_tables();
                    return JSON.stringify(output);
                });

                self.save = function () {
                    self.save.state('saving');
                    $.post(self.urls.save(), self.output()).done(function (data) {
                        window.location.href = data.redirect;
                    }).fail(function () {
                        self.save.state('error');
                        alert('There was an error saving.');
                    });
                };
                self.save.state = ko.observable('save');

                setTimeout(function () {
                    _(self.table_configuration()).each(function (table) {
                        _(table.column_configuration()).each(function (column) {
                            if (!column.display()) {
                                var parsed = self.utils.parseField(column.index(), table.index());
                                var display = parsed.field;
                                if (parsed.tag) {
                                    display = parsed.tag + '.' + parsed.field;
                                }
                                column.display(display);
                            }
                        });
                    });
                }, 0);

                return self;
            },
            excludedTables: {
                '#.#export_tag.#': null,
                '#.export_tag.#': null,
                '#.location_.#': null
            }
        };

        $(function () {
            var customExportView = CustomExportView.wrap({
                custom_export: {{ custom_export|JSON }},
                table_configuration: {{ table_configuration|JSON }},
                presave: {{ presave|JSON }},
                deid_options: {{ deid_options|JSON }},
                urls: {
                    save: {{ request.get_full_path|safe|JSON }}
                }
            });

            ko.applyBindings(customExportView, $('#customize-export').get(0));
        });
    </script>
{% endblock %}

{% block page-title %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url reports_home domain %}"><strong>{% trans "Project Reports" %}</strong></a>
            <span class="divider">&gt;</span>
        </li>
        <li>
            <a href="{{ helper.back_url }}">{{ helper.export_title }}</a>
            <span class="divider">&gt;</span>
        </li>
        <li class="active">
            <a href="#">{% trans "Create Custom Export" %}</a>
        </li>
    </ul>
{% endblock %}

{% block main_column %}
<div id="customize-export">
    <form class="form-horizontal" method="post">
        <fieldset>
            <legend>{% trans "Export Settings" %}</legend>
            <div class="control-group">
                <label for="export-name" class="control-label">{% trans "Export Name" %}</label>
                <div class="controls">
                    <input type="text" id="export-name" data-bind="value: custom_export.name" />
                </div>
            </div>
            <div class="control-group">
                <label for="format-select" class="control-label">{% trans "Default file type" %}</label>
                <div class="controls">
                    <select id="format-select" data-bind="value: custom_export.default_format">
                        <option value="xlsx">Excel 2007</option>
                        <option value="xls">Excel (older versions)</option>
                        <option value="csv">CSV (Zip file)</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
            {% if custom_export.type == 'form' %}
                    <label class="checkbox">
                        <input type="checkbox" id="include-errors-checkbox" data-bind="checked: custom_export.include_errors" />
                        {% trans "Include duplicates and other unprocessed forms" %}
                    </label>
            {% endif %}
                    <label class="checkbox">
                        <input type="checkbox" id="presave-checkbox" data-bind="checked: presave" />
                        {% trans "Save this report daily?" %}
                    </label>
                </div>
            </div>
        </fieldset>
        <fieldset data-bind="foreach: table_configuration">
            <legend data-bind="visible: !(index() in CustomExportView.excludedTables) || selected()">
                <input type="checkbox" data-bind="checked: selected" />
                <span data-bind="visible: index() === '#'">
                    {% trans "Export Fields" %}
                </span>
                <span data-bind="visible: index() !== '#'">
                    {% trans "Repeat: " %}
                    <span data-bind="text: $root.utils.stripIndex(index())">
                </span>
            </legend>
            <div data-bind="visibleFade: selected">
            <div class="control-group">
                <label class="control-label">{% trans "Table Name" %}</label>
                <div class="controls">
                    <input type="text" data-bind="value: display" />
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">
                    <strong>{% trans "Choose the fields you want to export." %}</strong><br />
                    {% trans "You can drag and drop fields to reorder them.  You can also rename fields, which will update the headers in the export file." %}
                </label>
                <div class="controls">
                    <table class="table table-striped table-bordered table-condensed" id="field-select">
                        <thead>
                        <tr class="nodrag nodrop">
                            <th></th>
                            <th>{% trans "Include this Field?" %}<br>
                                <a href="#" class="btn btn-mini" data-bind="click: $root.selectAll">{% trans "Select All" %}</a>
                                <a href="#" class="btn btn-mini btn-inverse" data-bind="click: $root.selectNone">{% trans "Select None" %}</a></th>
                            <th>{% trans "Field" %}</th>
                            <th>{% trans "Display" %}</th>
                            <th class="deid-column" data-bind="visible: $root.showDeidColumn()">{% trans "Sensitivity" %}</th>
                        </tr>
                        </thead>
                        <tbody data-bind="sortable: column_configuration">
                            <tr>
                                <td class="sortable-handle">
                                    <i class="icon-resize-vertical"></i>
                                </td>
                                <td><input type="checkbox" class="field-include" data-bind="checked: selected" /></td>
                                <td>
                                    <span class="label" data-bind="text: $root.utils.parseField(index, $parent.index).tag, visible: $root.utils.parseField(index, $parent.index).tag"></span>
                                    <code data-bind="text: $root.utils.parseField($data.index, $parent.index).field"></code>

                                </td>
                                <td><input class="input-xlarge" type="text" data-bind="value: display" /></td>
                                <td class="deid-column" data-bind="visible: $root.showDeidColumn()">
                                    <select data-bind="
                                        value: transform || '',
                                        foreach: $root.deid_options,
                                        visible: index() !== 'id' || transform()
                                    ">
                                        <option data-bind="value: value, text: label"></option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </fieldset>
        {% if helper.allow_deid %}
        <fieldset>
            <legend>Privacy Settings</legend>
            <div class="control-group">
                <label for="is_safe" class="control-label"></label>
                <div class="controls deid-column" data-bind="visible: $root.showDeidColumn()">
                    <label class="checkbox">
                        <input type="checkbox" id="is_safe" data-bind="checked: custom_export.is_safe" />
                        Publish in {{ DeidExportReport_name }}
                    </label>
                    <span class="help-inline">{% trans "Check only if this export has been fully and safely de-identified." %}</span>
                </div>
                <button class="btn" data-bind="
                    visible: !showDeidColumn(),
                    click: animateShowDeidColumn
                ">
                    {% trans "Allow me to mark sensitive data" %}
                </button>
            </div>
        </fieldset>
        {% endif %}
        <div class="form-actions">
            <button type="submit" class="btn btn-large btn-primary" data-bind="
                click: save
            ">
                <span data-bind="visible: save.state() === 'save'">
                    <span data-bind="visible: custom_export._id && custom_export._id()">{% trans "Save" %}</span>
                    <span data-bind="visible: !custom_export._id || !custom_export._id()">{% trans "Create" %}</span>
                </span>
                <span data-bind="visible: save.state() === 'saving'">
                    <i class="icon-refresh icon-spin"></i>
                    {% trans "Saving" %}
                </span>
                <span data-bind="visible: save.state() === 'error'">
                    {% trans "Try Again" %}
                </span>

            </button>
            <a class="btn btn-large" href="{{ helper.back_url }}">Cancel</a>
            {% if custom_export.get_id %}
            <a class="btn btn-large btn-danger pull-right" data-toggle="modal" href="#delete-export-modal-{{ custom_export.get_id }}">
                <i class="icon-remove icon-white"></i>
                {% trans "Delete this Export" %}
            </a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}


{% block modals %}{{ block.super }}
    {% if custom_export.get_id %}
        {% with custom_export as export %}
            {% include "reports/dialogs/delete_custom_export_dialog.html" %}
        {% endwith %}
    {% endif %}
{% endblock %}
